#! /usr/bin/env bash

first_name="${BASH_SOURCE[0]}"
actual_name="$(readlink -f "${first_name}")"
local_path="$(dirname "${actual_name}")"
library_import_file="$(readlink -f "${local_path}/../lib/casetools")"

#===================================================================================
#                          Import tools library
#===================================================================================
. "${library_import_file}"

if ! . "$(bashlib --lib)"
then
    logging::fatal "bashlib module requirement not satistified"
fi

#===================================================================================
#                              Logging Options
#===================================================================================
logging::set_severity info

#===================================================================================
#                                Execute a subcommand if required
#===================================================================================
if [ -z "$1" ]
then
    :
elif (echo "$1" | grep -q '^[\-]')
then
    :
else
    subcommand="$(casetools::command_folder)/${1}"
    shift

    if [ -x "${subcommand}" ]
    then
        exec "${subcommand}" "$@"
    else
        logging::fatal "No such command '${subcommand}'"
    fi
fi

#===================================================================================
#                              Help Message
#===================================================================================
showhelp() {
    local _synopsis="
        Manage Project Cases
    "

    local -A _keywords=(
        ["case::"]="Select a project or provide the currently selected project"
        ["detect:"]="Determine existence of a project"
        [shell]="Run a console shell in the selected project virtualenv",
        [console]="Run a console shell in the selected project's virtualenv",
        [description::]="Provide or display the project's description",
        [module::]="Provide a git package dependency or list the project's existing dependencies",
        [modules::]="Provide a git package dependency or list the project's existing dependencies",
        ["list::"]="List the known project names (open|closed)",
        [update]="Refresh all of the project dependencies",
        [requirements]="List the project's existing dependencies",
        [date]="Provide the project's creation date",
        [browse]="Open a file browser in the project's home directory",
        [exec:]="Run a shell command in the selected project's virtualenv",
        [where]="Display the project's home directory",
        [home::]="Display or set the base directory where the projects are contained",
        [pack:]="Archive the current project to a file",
        [tag:]="Add a tag",
        [untag:]="Remove a tag",
        [tags]="List tags",
        [exclude:]="Add folder to exclude from archiving",
        [unpack:]="Restore an archived project from a file",
        [help]="Display instructions"
        [commands]="List available subcommands"
    )

    local _terms="$(echo "${@}" | awk -F, '{for (i=1; i <= NF; ++i) {print $i;}}')"
    local _topic

    local _contents="$(
        echo "${_terms}" | awk -F: '{printf("%s[--%s%s]", sep, $1, (NF == 2 ? sprintf("=<%s>", $1) : "")); sep=" "}'
        echo -en "${_synopsis:+\n}"
        echo "${_synopsis}" | sed -e 's/^[ ]*//g' -e '/^[ ]*$/d'

        echo "${_terms}" | {
            _prefix="\n"

            while read _topic
            do
                if [ -n "${_keywords["${_topic}"]}" ]
                then
                    _fill="$(for ((i=$(echo -n "${_topic}" | wc -c); i < 15; ++i)); do echo -n " "; done)"
                    echo -e "${_prefix}--${_topic}${_fill}${_keywords["${_topic}"]}" | sed -e 's/^./    &/g'
                    _prefix=""
                fi
            done
        }
    )"

    echo "Usage: $0 ${_contents}" >&2
}

#===================================================================================
# NOTE: There is a bug in getopts where not specifying at least one short option
#       will cause the first non option parameter to be discarded. Here, we just
#       use -h (help)
#===================================================================================
long_options=
long_options="${long_options}${long_options:+,}help,version,lib"
long_options="${long_options}${long_options:+,}debug,error,info,warning,fatal"
long_options="${long_options}${long_options:+,}case::,shell,console,description::,module::,modules::"
long_options="${long_options}${long_options:+,}list::,update,requirements,date,browse,exec:,where"
long_options="${long_options}${long_options:+,}exclude:,home::,pack:,unpack:,detect:,commands"
long_options="${long_options}${long_options:+,}tag:,untag:,tags"

OPTION_TEMP=$(getopt -a -o hv --long ${long_options} -- "$@")

if [ $? != 0 ]
then
    logging::fatal "Invalid command line options ${OPTION_TEMP}"
fi

eval set -- "$OPTION_TEMP"

#===================================================================================
#                       Process command line parameters
#
# NOTE: The command line parameters are available for scripts which
#       source this file.
#===================================================================================
excluded_folders=()

if [ -d "${CASETOOLS_BASE}" ]
then
    :
elif mkdir -p "${CASETOOLS_BASE}"
then
    logging::warning "Created case folder in '${CASETOOLS_BASE}'"
else
    logging::fatal "Can't use casetool environments in folder '${CASETOOLS_BASE}'"
fi

while true
do
    case "$1" in
        --debug|--info|--warning|--fatal|--error)
            logging::set_severity "$(echo "${1}" | sed -e 's/^[\-]*//g')"
            shift
            ;;

        --detect)
            _name="${2}"
            shift 2
            _case="$(echo "${_name}" | url::encode)"
            _case_folder="${CASETOOLS_BASE}/${_case}"

            if [ -n "${_name}" -a -d "${_case_folder}" -a -d "${_case_folder}/Environment" ]
            then
                logging::debug "Case ${_name} exists"
                exit 0
            fi

            logging::warning "Case ${_name} doesn't exist"
            exit 255
            ;;

        --home)
            if [ -z "${2}" ]
            then
                echo ${CASETOOLS_BASE}
                exit 0
            elif [ ! -d "${2}" ]
            then
                logging::error "Project group folder '${2}' doesn't exist"
                exit 255
            else
                export CASETOOLS_BASE="${2}"
            fi

            shift 2
            ;;

        --list)
            cases::list "${2:-all}"
            shift 2
            ;;

        --module|--modules)
            if [ -z "${2}" ]
            then
                cases::requirements
            else
                cases::module "${2}"
            fi

            shift 2
            ;;

        --requirements)
            cases::requirements
            shift
            ;;

        --date)
            cases::date
            shift
            ;;

        --description)
            cases::description "${2}"
            shift 2
            ;;

        --exclude)
            excluded_folders[${#excluded_folders[@]}]="${2}"
            shift 2
            ;;

        --update)
            _requirements="$(cases::requirements)"

            echo "${_requirements}" | while read _url
            do
                cases::module "${_url}"
            done

            shift
            ;;

        --case)
            if [ -n "${2}" ]
            then
                _name="${2}"
                _case="$(echo "${_name}" | url::encode)"
                _case_folder="${CASETOOLS_BASE}/${_case}"
                _just_created=false

                if [ -d "${_case_folder}" ]
                then
                    :
                elif ! cases::create "${_case_folder}" "${_name}"
                then
                    logging::fatal "Cannot create case in '${_case_folder}'"
                else
                    _just_created=true
                fi

                if . "${_case_folder}/Environment/bin/activate"
                then
                    logging::warning "Selected virtual environment in '$(virtualenv::path)'"
                    export CASETOOLS_CASE="${_case}" CASETOOLS_HOME="${CASETOOLS_BASE}/${_case}"
                    export LD_LIBRARY_PATH="$(virtualenv::path)/lib:${LD_LIBRARY_PATH}"
                else
                    logging::fatal "Cannot select virtual environment in '${_case_folder}'"
                fi

                if ${_just_created}
                then
                    # cases::module "https://github.com/damionw/webserve.git" &&
                    cases::description "${_name}" ||
                    logging::fatal "Cannot install required modules"
                fi
            elif [ -n "${CASETOOLS_CASE}" ]
            then
                echo "Selected case '$(echo "${CASETOOLS_CASE}" | url::decode)' in folder '${CASETOOLS_BASE}'"
            else
                echo "No case has been selected"
            fi

            shift 2
            ;;

        --browse)
            _folder="$(cases::selected)" && xdg-open "${_folder}"
            exit $?
            shift
            ;;

        --where)
            _folder="$(cases::selected)" && echo "${_folder}"
            exit $?
            shift
            ;;

        --exec)
            _command="${2}"
            shift 2

            if ! _folder="$(cases::selected)" _case="$(cases::case)"
            then
                logging::fatal "No environment selected"
                _status=$?
            else
                logging::warning "Entering environment $(virtualenv::path)"

                (
                    cd "${_folder}" &&
                    ENV="${_folder}/.profile" exec bash --noprofile -c ". .profile; ${_command}" && _status=$?
                )
                _status=$?

                logging::warning "Exiting environment $(virtualenv::path)"
            fi

            exit ${_status}
            ;;

        --shell|--console)
            if _folder="$(cases::selected)" _case="$(cases::case)"
            then
                logging::warning "Entering environment $(virtualenv::path)"

                (
                    cd "${_folder}" &&
                    _rc_options="$(test -f .profile && echo --posix || echo --norc)" &&
                    ENV="${_folder}/.profile" HISTFILE="${_folder}/.bash_history" PS1="[${_case}]> " exec bash --noprofile ${_rc_options} -i <&2 >&2
                )

                logging::warning "Exiting environment $(virtualenv::path)"
            fi

            shift
            exit 0
            ;;

        --lib)
            echo "${library_import_file}"
            shift
            exit 0
            ;;

        --pack)
            if _archive_file="${2:?Please provide an archive file to create}" && read -p "Enter passphrase: " -s _passphrase
            then
                echo
            else
                exit 255
            fi

            shift 2

            if cases::packaging::key "${_passphrase}" && cases::packaging::pack "${excluded_folders[@]}" > "${_archive_file}"
            then
                logging::info "Wrote archive of '$(cases::case)' to '${_archive_file}'"
            fi
            exit $?
            ;;

        --unpack)
            if _archive_file="${2:?Please provide an archive file to restore}" && read -p "Enter passphrase: " -s _passphrase
            then
                echo
            else
                exit 255
            fi

            shift 2

            cases::packaging::key "${_passphrase}" && cases::packaging::unpack < "${_archive_file}"
            exit $?
            ;;

        --version)
            casetools::version
            shift
            exit 0
            ;;

        --commands)
            find "$(casetools::command_folder)/" -mindepth 1 -maxdepth 1 -type f -executable -printf "%f\n" | sort
            shift
            exit 0
            ;;

        --tag)
            casetool::add_tag "${2}"
            shift 2
            ;;

        --untag)
            casetool::remove_tag "${2}"
            shift 2
            ;;

        --tags)
            casetool::list_tags
            shift
            exit 0
            ;;

        --)
            shift
            break
            ;;

        *)
            showhelp "${long_options}" >&2
            exit 0
            ;;
    esac
done
